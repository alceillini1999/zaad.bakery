<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Zaad Bakery — Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" href="/img/zaad-logo.jpeg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{ --brand:#7A4B2B; --accent:#CFA24A; --text:#3b3b3b; --bg:#f8f6f2; --card:#ffffff; --border:#e7ddcf; }
  body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",Arial,sans-serif; }
  .hero{ background:linear-gradient(135deg,#fff 0%,#fdf9f2 100%); border:1px solid var(--border); border-radius:18px; padding:18px 20px; margin:16px 0; display:flex; align-items:center; justify-content:space-between; gap:16px; }
  .brand{ display:flex; align-items:center; gap:12px; }
  .brand-logo{ height:44px; width:auto; object-fit:contain; border-radius:10px; background:#fff; border:1px solid var(--border); padding:6px; }
  .chip{ padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--border); font-size:.9rem; color:var(--brand) }
  .tab-card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(122,75,43,.06); }
  .nav-pills .nav-link{ color:var(--brand); border:1px solid var(--border); }
  .nav-pills .nav-link.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
  .btn-primary{ background:var(--brand); border-color:var(--brand); }
  .btn-outline-dark{ color:var(--brand); border-color:var(--brand); }
  .form-control:focus, .form-select:focus{ border-color:var(--accent); box-shadow:0 0 0 .2rem rgba(207,162,74,.2); }
  .denom-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px }
  @media(max-width:768px){ .denom-grid{ grid-template-columns:repeat(3,1fr); } }
  .gauge{ width:140px; height:140px; border-radius:50%; background:conic-gradient(var(--accent) var(--deg,0deg), #eee 0deg);
          display:flex; align-items:center; justify-content:center; margin:auto; border:6px solid #fff; box-shadow:inset 0 0 0 6px #fff; }
  .gauge span{ font-weight:700; color:var(--brand) }
</style>
</head>
<body>
<div class="container">
  <div class="hero">
    <div class="brand">
      <img id="brandLogo" src="/img/zaad-logo.jpeg" alt="Zaad Bakery" class="brand-logo">
      <script>
        (function(){ const lg = document.getElementById('brandLogo'); lg.onerror=()=>{ if(lg.src.endsWith('.jpeg')) lg.src='/img/zaad-logo.jpg'; else lg.src='/img/zaad-logo.png'; }; })();
      </script>
      <div><div class="fw-bold">Zaad Bakery</div><div class="text-muted" style="font-size:.9rem">Simple • Clean • Elegant</div></div>
    </div>
    <div class="d-flex flex-wrap" style="gap:8px">
      <span class="chip"><i class="bi bi-cash-coin me-1"></i>Cash</span>
      <span class="chip"><i class="bi bi-cart-check me-1"></i>Sales</span>
      <span class="chip"><i class="bi bi-credit-card-2-front me-1"></i>Expenses</span>
      <span class="chip"><i class="bi bi-people me-1"></i>Credit</span>
      <span class="chip"><i class="bi bi-graph-up me-1"></i>Reports</span>
      <button class="btn btn-outline-dark" id="openQR"><i class="bi bi-qr-code"></i> Open on phone</button>
    </div>
  </div>

  <ul class="nav nav-pills mb-3" id="tabs" style="gap:8px;">
    <li class="nav-item"><button class="nav-link active" data-tab="sales"><i class="bi bi-cart"></i> Sales</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="cash"><i class="bi bi-cash-coin"></i> Cash</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="expenses"><i class="bi bi-credit-card-2-front"></i> Expenses</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="credit"><i class="bi bi-people"></i> Credit</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="reports"><i class="bi bi-graph-up"></i> Reports</button></li>
  </ul>

  <!-- SALES -->
  <div class="tab-card" id="tab-sales">
    <h5 class="mb-3">Add Sale</h5>
    <form id="saleForm" class="row g-2">
      <div class="col-md-3"><label class="form-label">Amount</label><input type="number" min="0" step="0.01" class="form-control" name="amount" required></div>
      <div class="col-md-3"><label class="form-label">Payment</label>
        <select class="form-select" name="method" required>
          <option>Cash</option><option>Mobile Number</option><option>Buy Goods</option><option>Withdraw Cash</option>
        </select></div>
      <div class="col-md-3"><label class="form-label">Date</label><input type="date" class="form-control" name="date"></div>
      <div class="col-md-3"><label class="form-label">Note</label><input class="form-control" name="note" placeholder="Optional"></div>
      <div class="col-12 mt-2"><button class="btn btn-primary" type="submit"><i class="bi bi-save2 me-1"></i>Save</button></div>
    </form>

    <!-- Filters -->
    <div class="alert alert-light border mt-3">
      <div class="row g-2 align-items-end">
        <div class="col-sm-2"><label class="form-label">Date</label><input type="date" class="form-control" id="salesDate"></div>
        <div class="col-sm-3"><label class="form-label">Method</label>
          <select class="form-select" id="salesFMethod">
            <option value="">All</option><option>Cash</option><option>Mobile Number</option><option>Buy Goods</option><option>Withdraw Cash</option>
          </select></div>
        <div class="col-sm-2"><label class="form-label">Min</label><input type="number" class="form-control" id="salesFMin" step="0.01"></div>
        <div class="col-sm-2"><label class="form-label">Max</label><input type="number" class="form-control" id="salesFMax" step="0.01"></div>
        <div class="col-sm-3"><label class="form-label">Note contains</label><input class="form-control" id="salesFText" placeholder="any text"></div>
      </div>
      <div class="mt-2 d-flex" style="gap:8px">
        <button class="btn btn-outline-secondary" id="loadSales"><i class="bi bi-arrow-repeat me-1"></i>Load</button>
        <button class="btn btn-outline-success" id="exportSalesCsv"><i class="bi bi-filetype-csv me-1"></i>Export CSV</button>
        <button class="btn btn-outline-dark" id="salesClear">Clear filters</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Note</th></tr></thead>
        <tbody id="salesRows"></tbody>
      </table>
    </div>
  </div>

  <!-- CASH -->
  <div class="tab-card d-none" id="tab-cash">
    <h5 class="mb-3">Cash (Morning / Evening)</h5>
    <form id="cashForm">
      <div class="row g-2">
        <div class="col-md-3"><label class="form-label">Shift</label><select class="form-select" name="shift"><option value="morning">Morning</option><option value="evening">Evening</option></select></div>
        <div class="col-md-3"><label class="form-label">Date</label><input type="date" class="form-control" name="date"></div>
        <div class="col-md-6"><label class="form-label">Note</label><input class="form-control" name="note" placeholder="Optional"></div>
      </div>
      <div class="mt-3"><div class="denom-grid" id="denoms"></div></div>
      <div class="mt-2"><strong>Total: <span id="cashTotal">0</span></strong></div>
      <button class="btn btn-primary mt-2" type="submit"><i class="bi bi-cash-stack me-1"></i>Save Cash</button>
    </form>

    <div class="alert alert-light border mt-3">
      <div class="row g-2">
        <div class="col-sm-4"><label class="form-label">Date</label><input type="date" class="form-control" id="cashDate"></div>
      </div>
      <div class="mt-2 d-flex" style="gap:8px">
        <button class="btn btn-outline-secondary" id="loadCash"><i class="bi bi-arrow-repeat me-1"></i>Load</button>
        <button class="btn btn-outline-success" id="exportCashCsv"><i class="bi bi-filetype-csv me-1"></i>Export CSV</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>Date</th><th>Shift</th><th>Total</th><th>Note</th></tr></thead>
        <tbody id="cashRows"></tbody>
      </table>
    </div>
  </div>

  <!-- EXPENSES -->
  <div class="tab-card d-none" id="tab-expenses">
    <h5 class="mb-3">Add Expense</h5>
    <form id="expForm" class="row g-2">
      <div class="col-md-3"><label class="form-label">Amount</label><input type="number" min="0" step="0.01" class="form-control" name="amount" required></div>
      <div class="col-md-3"><label class="form-label">Category</label><input class="form-control" name="category" placeholder="Materials, Rent..."></div>
      <div class="col-md-3"><label class="form-label">Method</label>
        <select class="form-select" name="method"><option>Cash</option><option>Mobile Number</option><option>Buy Goods</option><option>Withdraw Cash</option></select></div>
      <div class="col-md-3"><label class="form-label">Date</label><input type="date" class="form-control" name="date"></div>
      <div class="col-12"><label class="form-label">Note</label><input class="form-control" name="note" placeholder="Optional"></div>
      <div class="col-12 mt-2"><button class="btn btn-primary" type="submit"><i class="bi bi-save2 me-1"></i>Save Expense</button></div>
    </form>

    <!-- Filters -->
    <div class="alert alert-light border mt-3">
      <div class="row g-2 align-items-end">
        <div class="col-sm-2"><label class="form-label">Date</label><input type="date" class="form-control" id="expDate"></div>
        <div class="col-sm-3"><label class="form-label">Method</label>
          <select class="form-select" id="expFMethod">
            <option value="">All</option><option>Cash</option><option>Mobile Number</option><option>Buy Goods</option><option>Withdraw Cash</option>
          </select></div>
        <div class="col-sm-3"><label class="form-label">Category / Note</label><input class="form-control" id="expFText"></div>
        <div class="col-sm-2"><label class="form-label">Min</label><input type="number" class="form-control" id="expFMin" step="0.01"></div>
        <div class="col-sm-2"><label class="form-label">Max</label><input type="number" class="form-control" id="expFMax" step="0.01"></div>
      </div>
      <div class="mt-2 d-flex" style="gap:8px">
        <button class="btn btn-outline-secondary" id="loadExp"><i class="bi bi-arrow-repeat me-1"></i>Load</button>
        <button class="btn btn-outline-success" id="exportExpCsv"><i class="bi bi-filetype-csv me-1"></i>Export CSV</button>
        <button class="btn btn-outline-dark" id="expClear">Clear filters</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>Date</th><th>Amount</th><th>Category</th><th>Method</th><th>Note</th></tr></thead>
        <tbody id="expRows"></tbody>
      </table>
    </div>
  </div>

  <!-- CREDIT -->
  <div class="tab-card d-none" id="tab-credit">
    <div class="row g-3">
      <div class="col-lg-6">
        <h5 class="mb-3">Add Credit Purchase</h5>
        <form id="creditPurchaseForm" class="row g-2">
          <div class="col-sm-6"><label class="form-label">Customer</label><select class="form-select" id="custSelectP" name="customer" required></select></div>
          <div class="col-sm-6"><label class="form-label">Amount</label><input type="number" min="0" step="0.01" class="form-control" name="amount" required></div>
          <div class="col-sm-6"><label class="form-label">Date</label><input type="date" class="form-control" name="date"></div>
          <div class="col-sm-6"><label class="form-label">Note</label><input class="form-control" name="note" placeholder="Optional"></div>
          <div class="col-12 mt-2"><button class="btn btn-primary" type="submit"><i class="bi bi-plus-circle me-1"></i>Add Purchase</button></div>
        </form>
      </div>
      <div class="col-lg-6">
        <h5 class="mb-3">Add Credit Payment</h5>
        <form id="creditPaymentForm" class="row g-2">
          <div class="col-sm-6"><label class="form-label">Customer</label><select class="form-select" id="custSelectPay" name="customer" required></select></div>
          <div class="col-sm-6"><label class="form-label">Amount</label><input type="number" min="0" step="0.01" class="form-control" name="amount" required></div>
          <div class="col-sm-6"><label class="form-label">Method</label>
            <select class="form-select" name="method"><option>Cash</option><option>Mobile Number</option><option>Buy Goods</option><option>Withdraw Cash</option></select></div>
          <div class="col-sm-6"><label class="form-label">Date</label><input type="date" class="form-control" name="date"></div>
          <div class="col-sm-12"><label class="form-label">Note</label><input class="form-control" name="note" placeholder="Optional"></div>
          <div class="col-12 mt-2"><button class="btn btn-success" type="submit"><i class="bi bi-check2-circle me-1"></i>Add Payment</button></div>
        </form>
      </div>
    </div>

    <div class="alert alert-light border mt-3">
      <div class="row g-2 align-items-end">
        <div class="col-sm-4"><label class="form-label">Customer</label><select class="form-select" id="creditFCustomer"><option value="">All</option></select></div>
        <div class="col-sm-4"><label class="form-label">Type</label><select class="form-select" id="creditFType"><option value="">All</option><option value="purchase">Purchase</option><option value="payment">Payment</option></select></div>
        <div class="col-sm-4">
          <label class="form-label">Add new customer</label>
          <div class="input-group">
            <input class="form-control" id="newCustomer" placeholder="Customer name">
            <button class="btn btn-outline-primary" id="addCustomer"><i class="bi bi-person-plus"></i></button>
          </div>
        </div>
      </div>
    </div>

    <h6>Customer Balances</h6>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>Customer</th><th>Purchases</th><th>Payments</th><th>Balance</th><th>Action</th></tr></thead>
        <tbody id="creditSummaryRows"></tbody>
      </table>
    </div>

    <div class="mt-3" id="creditDetailsBox" style="display:none;">
      <h6 class="mb-2">Details: <span id="creditDetailName"></span></h6>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Method</th><th>Note</th></tr></thead>
          <tbody id="creditDetailRows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- REPORTS (كما هي) -->
  <div class="tab-card d-none" id="tab-reports">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card p-3">
          <h6 class="mb-2">Select date</h6>
          <input type="date" class="form-control mb-2" id="repDate">
          <button class="btn btn-outline-primary w-100 mb-2" id="loadReport"><i class="bi bi-arrow-repeat me-1"></i>Load Daily Report</button>
          <button class="btn btn-dark w-100 mb-2" id="downloadDailyPdf"><i class="bi bi-filetype-pdf me-1"></i>Download Daily PDF</button>
          <button class="btn btn-success w-100 mb-3" id="downloadDailyXlsx"><i class="bi bi-file-earmark-spreadsheet me-1"></i>Download Excel (XLSX)</button>
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between"><span>Sales Total</span><strong id="rSales">0</strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Expenses Total</span><strong id="rExp">0</strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Profit</span><strong id="rProfit">0</strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Cash Morning</span><strong id="rCM">0</strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Cash Evening</span><strong id="rCE">0</strong></li>
            <li class="list-group-item d-flex justify-content-between"><span>Cash Diff</span><strong id="rCD">0</strong></li>
          </ul>
        </div>
        <div class="card p-3 mt-3">
          <h6 class="mb-2">Daily Target</h6>
          <input type="number" class="form-control mb-2" id="dailyTarget" placeholder="e.g. 50000">
          <div class="gauge mt-2" id="gauge" style="--deg:0deg"><span id="gaugeVal">0%</span></div>
          <div class="text-muted mt-2 text-center" style="font-size:.9rem">Gauge shows progress towards target</div>
        </div>
      </div>
      <div class="col-lg-8"><div class="card p-3"><h6 class="mb-3">Last 7 Days Sales</h6><canvas id="last7Chart" height="120"></canvas></div></div>
    </div>
  </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title"><i class="bi bi-qr-code me-1"></i> Open on your phone</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body text-center">
      <div id="qrBox" class="d-flex align-items-center justify-content-center" style="min-height:240px"></div>
      <div class="input-group mt-3"><span class="input-group-text">URL</span><input type="text" id="qrUrl" class="form-control" readonly><button class="btn btn-outline-secondary" id="copyUrl"><i class="bi bi-clipboard"></i></button></div>
      <div class="form-text mt-2">Make sure phone & PC on same Wi-Fi.</div>
    </div>
  </div></div>
</div>

<script>
const fmt = n => Number(n||0).toLocaleString('en-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

// Tabs
const tabs = document.querySelectorAll('#tabs .nav-link'); const views = ['sales','cash','expenses','credit','reports'];
tabs.forEach(b=> b.onclick = ()=>{ tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active'); const id=b.dataset.tab; views.forEach(v=>document.getElementById('tab-'+v).classList.toggle('d-none', v!==id)); });

// Denoms
const notes = [1000,500,200,100,50,40,20,10,5,1];
const denomsDiv = document.getElementById('denoms');
if (denomsDiv){ notes.forEach(n=>{ const w=document.createElement('div'); w.innerHTML=`<label class="form-label">${n}</label><input type="number" min="0" value="0" class="form-control denom" data-note="${n}">`; denomsDiv.appendChild(w); }); }
function computeCashTotal(){ let t=0; document.querySelectorAll('.denom').forEach(inp=>{ t += (+inp.dataset.note)*(+inp.value||0); }); document.getElementById('cashTotal').textContent=fmt(t); return t; }
document.addEventListener('input', (e)=>{ if(e.target.classList.contains('denom')) computeCashTotal(); });

// Fetch helpers
async function postJSON(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
function triggerDownload(url){ const a=document.createElement('a'); a.href=url; a.target='_blank'; document.body.appendChild(a); a.click(); a.remove(); }

// ===== Sales (w/ filters)
let salesData = [];
const salesDate = document.getElementById('salesDate');
const salesFMethod = document.getElementById('salesFMethod');
const salesFMin = document.getElementById('salesFMin');
const salesFMax = document.getElementById('salesFMax');
const salesFText = document.getElementById('salesFText');
document.getElementById('salesClear').onclick = ()=>{ salesFMethod.value=''; salesFMin.value=''; salesFMax.value=''; salesFText.value=''; renderSales(); };

let savingSale=false;
const saleForm=document.getElementById('saleForm');
saleForm?.addEventListener('submit', async (e)=>{
  e.preventDefault(); if (savingSale) return; savingSale=true;
  const btn=saleForm.querySelector('button[type="submit"]'); if(btn){ btn.disabled=true; btn.innerHTML='Saving…'; }
  try{
    const fd=new FormData(saleForm);
    await postJSON('/api/sales',{ amount:+fd.get('amount'), method:fd.get('method'), note:fd.get('note')||undefined, date:fd.get('date')||undefined });
    saleForm.reset(); loadSales();
  } finally { savingSale=false; if(btn){ btn.disabled=false; btn.innerHTML='<i class="bi bi-save2 me-1"></i>Save'; } }
});
document.getElementById('loadSales')?.addEventListener('click', loadSales);
document.getElementById('exportSalesCsv')?.addEventListener('click', ()=>{ const d=salesDate.value || new Date().toISOString().slice(0,10); triggerDownload('/api/export/csv/sales?date='+d); });
[salesFMethod,salesFMin,salesFMax,salesFText].forEach(el=> el.addEventListener('input', renderSales));

async function loadSales(){
  const d = salesDate.value || new Date().toISOString().slice(0,10);
  salesData = await getJSON('/api/sales?date='+d);
  renderSales();
}
function renderSales(){
  const rows=document.getElementById('salesRows'); rows.innerHTML='';
  const m=salesFMethod.value, min=parseFloat(salesFMin.value||''), max=parseFloat(salesFMax.value||''), txt=(salesFText.value||'').toLowerCase();
  salesData.filter(s=>{
    if (m && s.method!==m) return false;
    if (!Number.isNaN(min) && (+s.amount)<min) return false;
    if (!Number.isNaN(max) && (+s.amount)>max) return false;
    if (txt && !((s.note||'').toLowerCase().includes(txt))) return false;
    return true;
  }).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(s.date).toLocaleString()}</td><td><strong>${fmt(s.amount)}</strong></td><td>${s.method}</td><td>${s.note||''}</td>`;
    rows.appendChild(tr);
  });
}

// ===== Cash
const cashForm=document.getElementById('cashForm'); let savingCash=false;
cashForm?.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(savingCash) return; savingCash=true;
  const btn=cashForm.querySelector('button[type="submit"]'); if(btn){ btn.disabled=true; btn.innerHTML='Saving…'; }
  try{
    const fd=new FormData(cashForm); const denominations={}; document.querySelectorAll('.denom').forEach(inp=>denominations[inp.dataset.note]=parseInt(inp.value||0));
    await postJSON('/api/cash',{ shift:fd.get('shift'), note:fd.get('note')||undefined, date:fd.get('date')||undefined, denominations });
    loadCash();
  } finally { savingCash=false; if(btn){ btn.disabled=false; btn.innerHTML='<i class="bi bi-cash-stack me-1"></i>Save Cash'; } }
});
const cashDate=document.getElementById('cashDate');
document.getElementById('loadCash')?.addEventListener('click', loadCash);
document.getElementById('exportCashCsv')?.addEventListener('click', ()=>{ const d=cashDate.value || new Date().toISOString().slice(0,10); triggerDownload('/api/export/csv/cash?date='+d); });
async function loadCash(){ const d=cashDate.value || new Date().toISOString().slice(0,10); const rows=document.getElementById('cashRows'); rows.innerHTML=''; (await getJSON('/api/cash?date='+d)).forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(c.date).toLocaleDateString()}</td><td>${c.shift}</td><td><strong>${fmt(c.total)}</strong></td><td>${c.note||''}</td>`; rows.appendChild(tr); }); }

// ===== Expenses (w/ filters)
let expData=[];
const expDate=document.getElementById('expDate');
const expFMethod=document.getElementById('expFMethod');
const expFText=document.getElementById('expFText');
const expFMin=document.getElementById('expFMin');
const expFMax=document.getElementById('expFMax');
document.getElementById('expClear').onclick=()=>{ expFMethod.value=''; expFText.value=''; expFMin.value=''; expFMax.value=''; renderExpenses(); };

let savingExp=false;
const expForm=document.getElementById('expForm');
expForm?.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(savingExp) return; savingExp=true;
  const btn=expForm.querySelector('button[type="submit"]'); if(btn){ btn.disabled=true; btn.innerHTML='Saving…'; }
  try{
    const fd=new FormData(expForm);
    await postJSON('/api/expenses',{ amount:+fd.get('amount'), category:fd.get('category')||undefined, method:fd.get('method')||'Cash', note:fd.get('note')||undefined, date:fd.get('date')||undefined });
    expForm.reset(); loadExpenses();
  } finally { savingExp=false; if(btn){ btn.disabled=false; btn.innerHTML='<i class="bi bi-save2 me-1"></i>Save Expense'; } }
});
document.getElementById('loadExp')?.addEventListener('click', loadExpenses);
document.getElementById('exportExpCsv')?.addEventListener('click', ()=>{ const d=expDate.value || new Date().toISOString().slice(0,10); triggerDownload('/api/export/csv/expenses?date='+d); });
[expFMethod,expFText,expFMin,expFMax].forEach(el=> el.addEventListener('input', renderExpenses));

async function loadExpenses(){ const d=expDate.value || new Date().toISOString().slice(0,10); expData=await getJSON('/api/expenses?date='+d); renderExpenses(); }
function renderExpenses(){
  const rows=document.getElementById('expRows'); rows.innerHTML='';
  const m=expFMethod.value, txt=(expFText.value||'').toLowerCase(), min=parseFloat(expFMin.value||''), max=parseFloat(expFMax.value||'');
  expData.filter(x=>{
    if (m && x.method!==m) return false;
    if (txt && !((x.category||'').toLowerCase().includes(txt) || (x.note||'').toLowerCase().includes(txt))) return false;
    if (!Number.isNaN(min) && (+x.amount)<min) return false;
    if (!Number.isNaN(max) && (+x.amount)>max) return false;
    return true;
  }).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(x.date).toLocaleDateString()}</td><td><strong>${fmt(x.amount)}</strong></td><td>${x.category||''}</td><td>${x.method||''}</td><td>${x.note||''}</td>`;
    rows.appendChild(tr);
  });
}

// ===== Credit (customers + filters)
async function refreshCustomers(){
  const list = await getJSON('/api/credit/customers');
  const selP=document.getElementById('custSelectP'), selPay=document.getElementById('custSelectPay'), fsel=document.getElementById('creditFCustomer');
  [selP, selPay].forEach(sel=>{ sel.innerHTML=''; list.forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o); }); });
  fsel.innerHTML='<option value="">All</option>'; list.forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; fsel.appendChild(o); });
}
document.getElementById('addCustomer')?.addEventListener('click', async ()=>{
  const name=document.getElementById('newCustomer').value?.trim(); if(!name) return;
  await postJSON('/api/credit/customers',{ name }); document.getElementById('newCustomer').value=''; refreshCustomers(); loadCreditSummary();
});

const creditFType=document.getElementById('creditFType'); const creditFCustomer=document.getElementById('creditFCustomer');

let savingCredP=false, savingCredPay=false;
document.getElementById('creditPurchaseForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(savingCredP) return; savingCredP=true;
  const btn=e.target.querySelector('button[type="submit"]'); if(btn){ btn.disabled=true; btn.innerHTML='Saving…'; }
  try{
    const fd=new FormData(e.target);
    await postJSON('/api/credit/purchase',{ customer:fd.get('customer'), amount:+fd.get('amount'), note:fd.get('note')||undefined, date:fd.get('date')||undefined });
    e.target.reset(); loadCreditSummary();
  } finally { savingCredP=false; if(btn){ btn.disabled=false; btn.innerHTML='<i class="bi bi-plus-circle me-1"></i>Add Purchase'; } }
});
document.getElementById('creditPaymentForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(savingCredPay) return; savingCredPay=true;
  const btn=e.target.querySelector('button[type="submit"]'); if(btn){ btn.disabled=true; btn.innerHTML='Saving…'; }
  try{
    const fd=new FormData(e.target);
    await postJSON('/api/credit/payment',{ customer:fd.get('customer'), amount:+fd.get('amount'), method:fd.get('method')||'Cash', note:fd.get('note')||undefined, date:fd.get('date')||undefined });
    e.target.reset(); loadCreditSummary();
  } finally { savingCredPay=false; if(btn){ btn.disabled=false; btn.innerHTML='<i class="bi bi-check2-circle me-1"></i>Add Payment'; } }
});

creditFType.addEventListener('change', renderCreditSummary);
creditFCustomer.addEventListener('change', renderCreditSummary);

let creditSummary=[];
async function loadCreditSummary(){ creditSummary = await getJSON('/api/credit/summary'); renderCreditSummary(); }
function renderCreditSummary(){
  const rows=document.getElementById('creditSummaryRows'); rows.innerHTML='';
  const cust=creditFCustomer.value, type=creditFType.value;
  const data = creditSummary.filter(c => !cust || c.customer===cust);
  data.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.customer}</td><td>${fmt(c.purchase)}</td><td>${fmt(c.payment)}</td><td><strong>${fmt(c.balance)}</strong></td>
      <td class="d-flex" style="gap:6px">
        <button class="btn btn-sm btn-outline-primary viewBtn"><i class="bi bi-eye"></i></button>
        ${c.balance>0 ? `<button class="btn btn-sm btn-success settleBtn"><i class="bi bi-cash"></i> Settle</button>` : ''}
      </td>`;
    tr.querySelector('.viewBtn').onclick = ()=> loadCreditDetails(c.customer, type);
    const sb = tr.querySelector('.settleBtn');
    if (sb) sb.onclick = async ()=>{ await postJSON('/api/credit/payment',{ customer:c.customer, amount:c.balance, method:'Cash' }); loadCreditSummary(); };
    rows.appendChild(tr);
  });
}
async function loadCreditDetails(customer, typeFilter){
  const box=document.getElementById('creditDetailsBox'); const nameEl=document.getElementById('creditDetailName'); const rows=document.getElementById('creditDetailRows');
  nameEl.textContent=customer; rows.innerHTML='';
  let data = await getJSON('/api/credit?customer='+encodeURIComponent(customer));
  if (typeFilter) data = data.filter(r=> r.type===typeFilter);
  data.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(r.date).toLocaleString()}</td><td>${r.type}</td><td>${fmt(r.amount)}</td><td>${r.method||''}</td><td>${r.note||''}</td>`; rows.appendChild(tr); });
  box.style.display='block';
}

// ===== Reports (unchanged)
let last7Chart;
document.getElementById('loadReport')?.addEventListener('click', loadReport);
document.getElementById('downloadDailyPdf')?.addEventListener('click', ()=>{ const d=(document.getElementById('repDate').value || new Date().toISOString().slice(0,10)); triggerDownload('/api/export/pdf/daily?date='+d); });
document.getElementById('downloadDailyXlsx')?.addEventListener('click', ()=>{ const d=(document.getElementById('repDate').value || new Date().toISOString().slice(0,10)); triggerDownload('/api/export/xlsx/daily?date='+d); });
async function loadReport(){
  const d=document.getElementById('repDate').value || new Date().toISOString().slice(0,10);
  const rep=await getJSON('/api/reports/daily?date='+d);
  ['rSales','rExp','rProfit','rCM','rCE','rCD'].forEach((id,i)=>{
    const v=[rep.salesTotal,rep.expensesTotal,rep.profit,rep.cashMorning,rep.cashEvening,rep.cashDiff][i]; document.getElementById(id).textContent=fmt(v);
  });
  const target=parseFloat(document.getElementById('dailyTarget').value||0); let pct=0; if(target>0) pct=Math.min(100,Math.round((rep.salesTotal/target)*100));
  const deg=Math.round((pct/100)*360); const g=document.getElementById('gauge'); const gv=document.getElementById('gaugeVal'); g.style.setProperty('--deg',deg+'deg'); gv.textContent=pct+'%';
}
async function loadLast7(){
  const data=await getJSON('/api/reports/last7'); const labels=data.map(d=>d.date), vals=data.map(d=>d.total);
  const ctx=document.getElementById('last7Chart'); if(last7Chart) last7Chart.destroy();
  last7Chart=new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Sales', data:vals, backgroundColor:'rgba(207,162,74,0.35)', borderColor:'#7A4B2B', borderWidth:2 }] },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ callback:v=>fmt(v) } } }, plugins:{ tooltip:{ callbacks:{ label:(c)=>' '+fmt(c.raw) } } } } });
}

// ===== QR
document.getElementById('openQR')?.addEventListener('click', async()=>{
  const info=await getJSON('/api/meta/lan'); const url=info.url;
  document.getElementById('qrUrl').value=url; const box=document.getElementById('qrBox'); box.innerHTML=''; new QRCode(box,{ text:url, width:220, height:220 });
  new bootstrap.Modal(document.getElementById('qrModal')).show();
});
document.getElementById('copyUrl')?.addEventListener('click',()=>{ const el=document.getElementById('qrUrl'); el.select(); el.setSelectionRange(0,99999); navigator.clipboard?.writeText(el.value); });

// ===== Realtime
const socket = io();
socket.on('data:changed', (msg)=>{
  switch(msg.bucket){
    case 'sales':    loadSales(); loadReport(); loadLast7(); break;
    case 'expenses': loadExpenses(); loadReport(); break;
    case 'cash':     loadCash(); loadReport(); break;
    case 'credit':   refreshCustomers(); loadCreditSummary(); break;
  }
});

// ===== Init
const todayISO=new Date().toISOString().slice(0,10);
['salesDate','cashDate','expDate','repDate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=todayISO; });
refreshCustomers().then(()=> loadCreditSummary());
loadSales(); loadCash(); loadExpenses(); loadReport(); loadLast7();
</script>
</body>
</html>